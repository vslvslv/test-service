name: Deploy to Kubernetes

on:
  workflow_run:
    workflows: ["Docker Build and Push"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    environment: 
      name: ${{ inputs.environment || 'production' }}
      url: https://your-domain.com/testservice/ui
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'latest'
    
    - name: Configure kubectl
      run: |
        mkdir -p $HOME/.kube
        echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > $HOME/.kube/config
        chmod 600 $HOME/.kube/config
    
    - name: Update image tags in manifests
      run: |
        cd k8s
        # Get the latest commit SHA or use the trigger SHA
        IMAGE_TAG="${{ github.sha }}"
        
        # Update API image
        sed -i "s|ghcr.io/YOUR_ORG/YOUR_REPO/api:latest|ghcr.io/${{ github.repository }}/api:main-${IMAGE_TAG:0:7}|g" api.yaml
        
        # Update Web image
        sed -i "s|ghcr.io/YOUR_ORG/YOUR_REPO/web:latest|ghcr.io/${{ github.repository }}/web:main-${IMAGE_TAG:0:7}|g" web.yaml
    
    - name: Create namespace if not exists
      run: |
        kubectl apply -f k8s/namespace.yaml
    
    - name: Create secrets
      run: |
        # Create MongoDB secret
        kubectl create secret generic mongodb-secret \
          --from-literal=password="${{ secrets.MONGODB_PASSWORD }}" \
          --from-literal=connection-string="mongodb://admin:${{ secrets.MONGODB_PASSWORD }}@mongodb:27017/TestService?authSource=admin" \
          --namespace=testservice \
          --dry-run=client -o yaml | kubectl apply -f -
        
        # Create RabbitMQ secret
        kubectl create secret generic rabbitmq-secret \
          --from-literal=password="${{ secrets.RABBITMQ_PASSWORD }}" \
          --namespace=testservice \
          --dry-run=client -o yaml | kubectl apply -f -
        
        # Create GHCR secret for pulling images
        kubectl create secret docker-registry ghcr-secret \
          --docker-server=ghcr.io \
          --docker-username=${{ github.actor }} \
          --docker-password=${{ secrets.GITHUB_TOKEN }} \
          --namespace=testservice \
          --dry-run=client -o yaml | kubectl apply -f -
    
    - name: Deploy infrastructure (MongoDB & RabbitMQ)
      run: |
        kubectl apply -f k8s/mongodb.yaml
        kubectl apply -f k8s/rabbitmq.yaml
    
    - name: Wait for infrastructure to be ready
      run: |
        kubectl wait --for=condition=ready pod \
          -l app=mongodb \
          --namespace=testservice \
          --timeout=300s
        
        kubectl wait --for=condition=ready pod \
          -l app=rabbitmq \
          --namespace=testservice \
          --timeout=300s
    
    - name: Deploy API
      run: |
        kubectl apply -f k8s/api.yaml
        kubectl rollout status deployment/testservice-api -n testservice --timeout=300s
    
    - name: Deploy Web
      run: |
        kubectl apply -f k8s/web.yaml
        kubectl rollout status deployment/testservice-web -n testservice --timeout=300s
    
    - name: Apply Ingress
      run: |
        kubectl apply -f k8s/ingress.yaml
    
    - name: Get deployment status
      run: |
        echo "### Deployment Status ###"
        kubectl get pods -n testservice
        kubectl get services -n testservice
        kubectl get ingress -n testservice
    
    - name: Verify API health
      run: |
        echo "Waiting for API to be healthy..."
        sleep 30
        API_POD=$(kubectl get pod -n testservice -l app=testservice-api -o jsonpath="{.items[0].metadata.name}")
        kubectl exec -n testservice $API_POD -- wget -qO- http://localhost/health || echo "Health check skipped"
    
    - name: Create deployment summary
      run: |
        echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Deployed to: ${{ inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“¦ API Image: \`ghcr.io/${{ github.repository }}/api:main-${GITHUB_SHA:0:7}\`" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“¦ Web Image: \`ghcr.io/${{ github.repository }}/web:main-${GITHUB_SHA:0:7}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Services" >> $GITHUB_STEP_SUMMARY
        kubectl get svc -n testservice -o wide >> $GITHUB_STEP_SUMMARY
