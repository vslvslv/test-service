name: Deploy to Azure

on:
  workflow_run:
    workflows: ["Docker Build and Push"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy-to-azure:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    environment: 
      name: ${{ inputs.environment || 'production' }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Deploy API to Azure Container Apps
      uses: azure/container-apps-deploy-action@v1
      with:
        resourceGroup: ${{ secrets.AZURE_RESOURCE_GROUP }}
        containerAppName: testservice-api
        imageToDeploy: ghcr.io/${{ github.repository }}/api:main-${{ github.sha }}
        containerAppEnvironment: ${{ secrets.AZURE_CONTAINER_ENV }}
        targetPort: 80
        environmentVariables: |
          ASPNETCORE_ENVIRONMENT=Production
          MongoDB__ConnectionString=secretref:mongodb-connection
          RabbitMQ__HostName=${{ secrets.RABBITMQ_HOST }}
          RabbitMQ__UserName=${{ secrets.RABBITMQ_USER }}
          RabbitMQ__Password=secretref:rabbitmq-password
    
    - name: Deploy Web to Azure Container Apps
      uses: azure/container-apps-deploy-action@v1
      with:
        resourceGroup: ${{ secrets.AZURE_RESOURCE_GROUP }}
        containerAppName: testservice-web
        imageToDeploy: ghcr.io/${{ github.repository }}/web:main-${{ github.sha }}
        containerAppEnvironment: ${{ secrets.AZURE_CONTAINER_ENV }}
        targetPort: 80
    
    - name: Get deployment URLs
      run: |
        API_URL=$(az containerapp show \
          --name testservice-api \
          --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
          --query properties.configuration.ingress.fqdn \
          --output tsv)
        
        WEB_URL=$(az containerapp show \
          --name testservice-web \
          --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
          --query properties.configuration.ingress.fqdn \
          --output tsv)
        
        echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Deployed to Azure Container Apps" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŒ API URL: https://${API_URL}" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŒ Web URL: https://${WEB_URL}" >> $GITHUB_STEP_SUMMARY
