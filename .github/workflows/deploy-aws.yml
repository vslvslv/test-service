name: Deploy to AWS ECS

on:
  workflow_run:
    workflows: ["Docker Build and Push"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy-to-ecs:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    environment: 
      name: ${{ inputs.environment || 'production' }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}
    
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2
    
    - name: Tag and push API image to ECR
      run: |
        docker pull ghcr.io/${{ github.repository }}/api:main-${{ github.sha }}
        docker tag ghcr.io/${{ github.repository }}/api:main-${{ github.sha }} \
          ${{ steps.login-ecr.outputs.registry }}/testservice-api:latest
        docker push ${{ steps.login-ecr.outputs.registry }}/testservice-api:latest
    
    - name: Tag and push Web image to ECR
      run: |
        docker pull ghcr.io/${{ github.repository }}/web:main-${{ github.sha }}
        docker tag ghcr.io/${{ github.repository }}/web:main-${{ github.sha }} \
          ${{ steps.login-ecr.outputs.registry }}/testservice-web:latest
        docker push ${{ steps.login-ecr.outputs.registry }}/testservice-web:latest
    
    - name: Update API ECS service
      run: |
        aws ecs update-service \
          --cluster ${{ secrets.ECS_CLUSTER }} \
          --service testservice-api \
          --force-new-deployment
    
    - name: Update Web ECS service
      run: |
        aws ecs update-service \
          --cluster ${{ secrets.ECS_CLUSTER }} \
          --service testservice-web \
          --force-new-deployment
    
    - name: Wait for API deployment
      run: |
        aws ecs wait services-stable \
          --cluster ${{ secrets.ECS_CLUSTER }} \
          --services testservice-api
    
    - name: Wait for Web deployment
      run: |
        aws ecs wait services-stable \
          --cluster ${{ secrets.ECS_CLUSTER }} \
          --services testservice-web
    
    - name: Create deployment summary
      run: |
        echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Deployed to AWS ECS" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“¦ Cluster: ${{ secrets.ECS_CLUSTER }}" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”„ Services updated with new task definitions" >> $GITHUB_STEP_SUMMARY
