#!/bin/bash

# ============================================================================
# Test Service Infrastructure - Status Check (Linux/macOS)
# ============================================================================

GREEN='\033[0;32m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

echo ""
echo "??????????????????????????????????????????????????????????????????"
echo "?         Test Service - Infrastructure Status                  ?"
echo "??????????????????????????????????????????????????????????????????"
echo ""

# Check Docker
echo "[Docker Status]"
echo "????????????????????????????????????????????????????????????????"
if docker info > /dev/null 2>&1; then
    echo -e "${GREEN}? Docker is running${NC}"
else
    echo -e "${RED}? Docker is not running${NC}"
    exit 1
fi
echo ""

# Check containers
echo "[Container Status]"
echo "????????????????????????????????????????????????????????????????"
docker ps --filter "name=testservice" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
echo ""

# Detailed health checks
echo "[Health Checks]"
echo "????????????????????????????????????????????????????????????????"

# MongoDB
if docker ps | grep -q "testservice-mongodb"; then
    echo -e "${GREEN}? MongoDB: Running${NC}"
    health=$(docker inspect --format "{{.State.Health.Status}}" testservice-mongodb 2>/dev/null)
    echo "   Health: $health"
    echo "   Connection: mongodb://admin:password123@localhost:27017/TestServiceDb"
else
    echo -e "${RED}? MongoDB: Not running${NC}"
fi
echo ""

# RabbitMQ
if docker ps | grep -q "testservice-rabbitmq"; then
    echo -e "${GREEN}? RabbitMQ: Running${NC}"
    health=$(docker inspect --format "{{.State.Health.Status}}" testservice-rabbitmq 2>/dev/null)
    echo "   Health: $health"
    echo "   AMQP: localhost:5672"
    echo "   Management: http://localhost:15672 (guest/guest)"
else
    echo -e "${RED}? RabbitMQ: Not running${NC}"
fi
echo ""

# Volume status
echo "[Volume Status]"
echo "????????????????????????????????????????????????????????????????"
docker volume ls --filter "name=testservice" --format "table {{.Name}}\t{{.Driver}}\t{{.Scope}}"
echo ""

# Network status
echo "[Network Status]"
echo "????????????????????????????????????????????????????????????????"
docker network ls --filter "name=testservice" --format "table {{.Name}}\t{{.Driver}}\t{{.Scope}}"
echo ""
